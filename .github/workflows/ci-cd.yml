name: CI/CD Pipeline for MERN Todo App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  validate-docker-config:
    name: Validate Docker files
    runs-on: ubuntu-latest
    outputs:
      ok: ${{ steps.check.outcome }}
    steps:
      - uses: actions/checkout@v4
      - name: Check required files
        id: check
        run: |
          REQUIRED=("docker-compose.yml" "todoBackend/Dockerfile" "todoFrontend/Dockerfile")
          MISSING=0
          for f in "${REQUIRED[@]}"; do
            if [ ! -f "$f" ]; then
              echo "Missing $f"
              MISSING=1
            else
              echo "Found $f"
            fi
          done
          if [ $MISSING -eq 1 ]; then
            echo "One or more required files missing"
            exit 1
          fi

  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    needs: validate-docker-config
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.adminCommand(\"ping\")' || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: todoBackend/package.json

      - name: Install backend dependencies
        run: npm ci --legacy-peer-deps
        working-directory: ./todoBackend

      - name: Start backend server (test mode)
        run: |
          # run the backend in background connecting to the GitHub Actions mongodb service
          export MONGODB_URI="mongodb://admin:password@localhost:27017/todoapp?authSource=admin"
          export JWT_SECRET="ci_test_jwt_secret_123"
          export PORT=5000
          export NODE_ENV=test
          cd todoBackend
          npm start &> backend.log &
          pid=$!
          echo "Backend started with PID $pid"
          # wait for server to come up
          for i in {1..20}; do
            if curl --fail http://localhost:5000/health >/dev/null 2>&1; then
              echo "Backend health OK"
              break
            fi
            echo "Waiting for backend..."
            sleep 2
          done
          # run quick API checks
          curl -f -X POST http://localhost:5000/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"username":"ci_user","email":"ci_user@example.com","password":"password123"}'
          curl -f -X POST http://localhost:5000/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"ci_user@example.com","password":"password123"}'
          kill $pid
        working-directory: .

  test-frontend:
    name: Test Frontend Build & Tests
    runs-on: ubuntu-latest
    needs: validate-docker-config

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: todoFrontend/package.json

      - name: Install frontend dependencies
        run: npm ci --legacy-peer-deps
        working-directory: ./todoFrontend

      - name: Build frontend
        run: |
          npm run build
          if [ ! -d "./build" ]; then
            echo "Build directory missing"
            exit 1
          fi
        working-directory: ./todoFrontend

      - name: Run frontend tests
        run: |
          npm test -- --watchAll=false --passWithNoTests
        working-directory: ./todoFrontend

  build-docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend Docker image
        run: |
          cd todoBackend
          docker build -t todo-backend:ci-latest .
          docker images todo-backend:ci-latest

      - name: Build frontend Docker image
        run: |
          cd todoFrontend
          docker build -t todo-frontend:ci-latest .
          docker images todo-frontend:ci-latest

      - name: List Docker images
        run: docker images

  integration-test:
    name: Integration test with docker-compose
    runs-on: ubuntu-latest
    needs: build-docker-images
    env:
      JWT_SECRET: ci_integration_jwt_secret
      MONGODB_INITDB_ROOT_USERNAME: admin
      MONGODB_INITDB_ROOT_PASSWORD: password

    steps:
      - uses: actions/checkout@v4

      - name: Start services with docker-compose
        run: |
          docker-compose up -d --build
          # Wait for services
          for i in {1..30}; do
            if curl --fail http://localhost:5000/health >/dev/null 2>&1; then
              echo "Backend healthy"
              break
            fi
            echo "Waiting for backend..."
            sleep 2
          done
          # Quick sanity check
          curl -f http://localhost:5000/health
      - name: Tear down
        if: always()
        run: docker-compose down

  success:
    name: Pipeline Complete
    runs-on: ubuntu-latest
    needs: [integration-test]
    if: always()
    steps:
      - name: Report
        run: |
          echo "CI/CD pipeline finished (check logs for details)"
